import Phaser, { Physics } from 'phaser';
import eventsCenter from '~/classes/eventCenter';

var doesStaminaMatter = true;

var cloudsWhite, cloudsWhiteSmall;
export default class Game extends Phaser.Scene
{
    private player?: Phaser.Physics.Arcade.Sprite;
    private enemy?: Phaser.Physics.Arcade.Sprite;
    private keys?: Phaser.Types.Input.Keyboard.CursorKeys;

    private score: number;
    private health: number;
    private canTakeDamage: boolean;
    private isGrounded: boolean;
    private flowerGroup;
    private stamina: number;

	constructor() {
		super('Game');
        this.health = 3;
        this.isGrounded = true;
        this.score = 0;
        this.stamina = 100;
	}

    init() {
        this.keys = this.input.keyboard.createCursorKeys();
        this.flowerGroup = this.add.group();

        this.scene.launch("UIScene");
    }

	preload()
    {
        this.load.spritesheet('bee', 'assets/cropped_bees.png', {
            frameWidth: 130, frameHeight: 118
        })

        this.load.image('mountain-close', 'assets/mountain-close.png');
        this.load.image('mountain-far', 'assets/mountain-far.png');


        this.load.image('flower', 'assets/flower-tile.png', );
        this.load.image('tiles', 'assets/world_tiles.png', );
        this.load.tilemapTiledJSON('tilemap', 'assets/map.json');
            
        this.load.image('bear', 'assets/bear.png');
        this.load.image('sky', 'assets/sky.png');

        this.load.image('clouds-white', 'assets/clouds-white.png');
        this.load.image("clouds-white-small", 'assets/clouds-white-small.png');
    }

    const bigfatarr: number[] = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0];

    
    findcoords(array: number[]): void {
        let tmpArr: Phaser.Physics.Arcade.Sprite[] = [];
        let count = 0;
        for (let y = 0; y < 25; y++) {
            for (let x = 0; x < 100; x++) {
                if (array[y*100 + x] === 1) {
                    this.flowerGroup.add(this.physics.add.sprite(x * 21, y * 21 + 10, 'flower').setDepth(49))
                }
            }
        }
    }

    create() {
        const {width, height} = this.scale // Width and Height

        this.createPlayerAnims();
        // START OF MAPMAKING
        const map = this.make.tilemap({ key: 'tilemap'});
        const tileset = map.addTilesetImage('grass-world', 'tiles');

        const ground = map.createLayer('ground', tileset)
        ground.setCollisionByProperty({collides: true})
        ground.setDepth(49);

        const objectsLayer = map.getObjectLayer('objects')
        
        //var pickupGroup = this.add.group();

        objectsLayer.objects.forEach(objData => {
            const { x, y, name } = objData
            switch (name) {
                case 'player-spawn': {
                    this.player = this.generatePlayer( x!, y!);
                    this.player.setDepth(50);
                }
            }
        })

        // Here she blows
        this.findcoords(this.bigfatarr);
        this.physics.add.overlap(this.player!, this.flowerGroup, this.collectFlower, undefined, this);
        

        // END OF MAPMAKING

        // Bee anims
        
        this.physics.add.collider(this.player!, ground, this.regroundPlayer, undefined, this);

        this.cameras.main.startFollow(this.player!);
        this.cameras.main.setZoom(5);

        const fullWidth = 2100;

        function makeLoopingBackground(img: Phaser.GameObjects.Image, key: string, scene: Phaser.Scene): Phaser.GameObjects.Image[]{
            
            return [ img,
                scene.add.image(width*0.5 - img.displayWidth, height*0.5, key).setDepth(img.depth).setScrollFactor(img.scrollFactorX,img.scrollFactorY).setScale(img.scale),
                scene.add.image(width*0.5 + img.displayWidth, height*0.5, key).setDepth(img.depth).setScrollFactor(img.scrollFactorX,img.scrollFactorY).setScale(img.scale)
            ];
        }

        const sky = this.add.image(width*0.5,height*0.5,'sky').setDepth(0).setOrigin(0.5, 1);
        
        const mountainclose = this.add.image(width*0.5,height*0.5,'mountain-close').setDepth(4).setScrollFactor(0.09, 0.12).setScale(0.2);
        const mountainsclose = makeLoopingBackground(mountainclose, 'mountain-close', this);

        const mountainfar = this.add.image(width*0.5,height*0.5,'mountain-far').setDepth(2).setScrollFactor(0.07, 0.1).setScale(0.2);
        const mountainsfar = makeLoopingBackground(mountainfar, 'mountain-far', this);


        
        cloudsWhite = this.add.tileSprite(width * 0.5, height * 0.5, 2100, 1575, "clouds-white").setDepth(3).setScrollFactor(0.1);
        cloudsWhiteSmall = this.add.tileSprite(width * 0.5, height * 0.5, 2100, 1575, "clouds-white-small").setDepth(1).setScrollFactor(0);
    
        this.scene.launch('ui-scene', { controller: this});
    }

    private collectFlower(player, flower) {
        if (flower.alpha == 1) {
            console.log('flower collected');
            flower.alpha = 0.65;
            this.score++;
            eventsCenter.emit('update-score-counter', this.score)
            if (this.score === 1) {
                this.win();
            }
        }
    }

    private regroundPlayer(player, ground) {
        if (player.body.deltaY() > 0) {
            this.isGrounded = true;
        }
        
    }

    // PLAYER FUNCTIONS
    private generatePlayer(x: number, y: number): Phaser.Physics.Arcade.Sprite {
        let player: Phaser.Physics.Arcade.Sprite =  this.physics.add.sprite( x, y, 'bee');
        player.setBounce(0.0);
        player.setGravityY(250);
        player.setScale(0.2);
        player.setCollideWorldBounds(true)
        player.setMaxVelocity(250);
        player.play("player-idle");
        return player;
    }

    private createPlayerAnims() {
        this.anims.create({
            key: "player-idle",
            frames: [{ key: "bee", frame: 3}]
        })

        this.anims.create({
            key: 'player-walking',
            frames: this.anims.generateFrameNumbers('bee', { 
                frames:  [1,2,3,2,1]
            }),
            frameRate: 10,
            repeat: 1
        })

        this.anims.create({
            key: 'player-flying',
            frames: this.anims.generateFrameNumbers('bee', {
                start: 0, end: 7
            }),
            frameRate: 10,
            repeat: 1
        })
    }

    private loseStamina(): void {
        if (this.stamina >= 0.2 && doesStaminaMatter) {
            this.stamina -= 1
            eventsCenter.emit('update-stamina', this.stamina)
        }
    }

    private recoverStamina(): void {
        if (this.stamina <= 99.8 && doesStaminaMatter) {
            this.stamina += 2
            eventsCenter.emit('update-stamina', this.stamina)
        }
    }
    
    /*
    * Controls the bee
    */
    private beeController(keys?: Phaser.Types.Input.Keyboard.CursorKeys, player?: Phaser.Physics.Arcade.Sprite): void {
        if(!keys || !player) {
            return;
        }
        if (this.isGrounded) {
            
            if(keys.left?.isDown) {
                player.flipX = false;
                player.setVelocityX(-100);
                player.anims.play('player-walking', true);
            } else if (keys.right?.isDown) {
                player.flipX = true;
                player.setVelocityX(100);
                player.anims.play('player-walking', true);
            } else {
                player.setVelocityX(0);
                player.setAccelerationX(0)
                player.anims.play('player-idle')
            } 
            
            if (keys.up?.isDown) {
                this.loseStamina()
                this.isGrounded = false;
                player.setVelocityY(-120);
            } else {
                player.setAccelerationY(100);
            }

        } else {
            if(keys.left?.isDown) {
                player.flipX = false;
                player.setAccelerationX(-200);
                player.anims.play('player-flying', true);
            } 
            else if (keys.right?.isDown) {
                player.flipX = true;
                player.setAccelerationX(200);
                player.anims.play('player-flying', true);
            } else {
                player.setAccelerationX(0);
                player.anims.play('player-flying', true);
            }
            
            if (keys.up?.isDown && this.stamina > 0.05) {
                this.isGrounded = false;
                player.setAccelerationY(-500);
                this.loseStamina()
            }  else {
                player.setAccelerationY(0);
            }
        }

        if (this.isGrounded) {
            this.recoverStamina();
        }
    
        
    }

    private handleHitEnemy(p: Phaser.GameObjects.GameObject, b: Phaser.GameObjects.GameObject) {
        if (this.canTakeDamage) {
            if (this.health > 0) {
                this.health--;
                this.hearts[this.health].setFrame(2);
                this.canTakeDamage = false;
                this.knockback(this.player, this.enemy);
                this.canTakeDamage = true;
            }
            else {
                this.scene.start("GameOverScene");
            }
        }
    }

    private knockback(player?: Phaser.Physics.Arcade.Sprite, b?: Phaser.Physics.Arcade.Sprite) {
        const xdiff = player!.body.position.x - b!.body.position.x;
        const ydiff = player!.body.position.y - b!.body.position.y;
        const magnitude = Math.sqrt(xdiff * xdiff + ydiff * ydiff);
        const normalX = xdiff / magnitude;
        const normalY = ydiff / magnitude;
        player?.setVelocity(normalX * 500, normalY * 500);
    }

    private win() {
        const centerX = this.cameras.main.centerX
        const centerY = this.cameras.main.centerY
        console.log("you win")
        this.add.text(centerX, centerY-30, "You Win!\nReturning to title screen",{align:'center', color:"black"}).setOrigin(0.5, 0.5).setScrollFactor(0).setDepth(120);
        this.scene.stop(this.scene.get("UIScene"))
        this.time.delayedCall(3000, () => {
            this.scene.switch('TitleScene')
        })
    }
    
    update() {
        this.beeController(this.keys, this.player);

        cloudsWhite.tilePositionX += 0.5;
        cloudsWhiteSmall.tilePositionX += 0.2;
    }
}
